<html>
<head>
<title>Social Media Monitoring : Popup</title>

<link rel="stylesheet" href="css/content.css" type="text/css" media="all" />
<script type="text/javascript" src="probe_manager.js"></script>
<script type="text/javascript" src="probe.js"></script>
<script type="text/javascript" src="lib/3rdparty/jquery-1.4.2.min.js"></script>
<script type="text/javascript" src="lib/3rdparty/jquery.effects.core.min.js"></script>

<script type="text/javascript">
var probeManager = chrome.extension.getBackgroundPage().getProbeManager();

var probeTags;

var probes, template, inputTag, spanTag, inputAvgWeek, inputAvgDay;

var port = chrome.extension.connect({name: "social-media-monitoring"});

chrome.extension.onConnect.addListener(function(port) {
	  console.assert(port.name == "social-media-monitoring");
	  port.onMessage.addListener(function(msg) {
		console.log('onMessage:' + msg);
		  if (msg.update) {
			  probeTags = msg.update;
			  console.log('onMessage[update]:' + probeTags);

			/*
			 * get right element from probe list
			 */
			  var tagObj = $('#f_' + probeTags.query.replace(" ","_") + '');

				 if (tagObj){

					 //$(tagObj).addClass('warn');
					 $(tagObj).removeClass('loader');
					 
					 $(' > span#tag',tagObj).html($(' > input#tag_input',tagObj).val());
					 
					 $(' > span#tag',tagObj).removeClass('hd');
					 $(' > input#tag_input',tagObj).addClass('hd');
					 $(' > input.avgWeek',tagObj).val(probeTags.shortTermTweetsPerHour);
					 $(' > input.avgDay',tagObj).val(probeTags.longTermTweetsPerHour);
				 }

		  }
		  if (msg.alert) {
			  probeTags = msg.alert;
			  console.log('onMessage[alert]:' + probeTags);
		  }	  
	  });
});

$(document).ready(function() {
	$("#btnAdd").click(function() {

		/*
		 * check if probe is filled
		 */
		var ignore = false;
		$('#f').each(function(i){

			 var tagObj = $(' > input#tag_input.tag',this);
			 var probeValue = tagObj.val();
			 console.log('probeValue:' + probeValue);
			 if (!probeValue){
				 $(tagObj).animate({backgroundColor: "#f4aeae"}, "fast").animate({backgroundColor: "#fffff"}, "fast");
				 ignore = true;
				 return false;
			 }
			 
			 if($(tagObj).is(':visible')){
				 $(tagObj).animate({backgroundColor: "#f4aeae"}, "fast").animate({backgroundColor: "#fffff"}, "fast");
				 ignore = true;
				 return false;
			 }

			 
			 
		});

		if(!ignore){
			addProbeHTML();
			addRemoveButtonListeners();
		}  
	});

});

function openResults() {
	var tagProbes = probeManager.loadProbes();
	
	if (false) {
		chrome.windows.create({url: tagProbes[0].searchQuery});
		chrome.windows.getLastFocused(function (window) {
		
			for (var j in tagProbes) {
				if (j > 0) {
					chrome.tabs.create({url: tagProbes[j].searchQuery, windowId: window.windowId});
				}
			}
		
		});
	} else {	
	
		for (var i in tagProbes) {
			chrome.tabs.create({url: tagProbes[i].searchQuery});
		}
	
	}
	return false;
}


</script>
<style type="text/css">
  @import url("http://www.google.com/uds/css/gsearch.css");
  @import url("http://www.google.com/uds/solutions/localsearch/gmlocalsearch.css");
</style>
</head>
<body onload="setTimeout(init,0);" class="popup">

<div id="options">

<a href="#" id="back" onclick="back();">Go back to the list</a>

<div id="geolocform">
	<form>
   	  <input id="location" type="text" name="location" value="Search Location"><select id="distance" name="distance"><option value="10">10</option><option value="20">20</option><option value="30">30</option><option value="40">40</option><option value="50">50</option><option value="60">60</option><option value="70">70</option><option value="80">80</option><option value="90">90</option><option value="100">100</option><option value="200">200</option></select><select id="unit" name="unit"><option value="km">kilometres</option><option value="mi">miles</option></select><br><div id="geonable"></div>
	</form>
</div>
   	
<div id="map_canvas" style="width: 200px; height: 200px; position: relative; background-color: rgb(229, 227, 223); "></div>

<button type="button">Save Location</button>


<script src="http://maps.google.com/maps?file=api&amp;v=2&amp;key=ABQIAAAATfHumDbW3OmRByfquHd3SRTRERdeAiwZ9EeJWta3L_JZVS0bOBRQeZgr4K0xyVKzUdnnuFl8X9PX0w&sensor=false"
        type="text/javascript"></script>

<script src="http://www.google.com/uds/solutions/localsearch/gmlocalsearch.js" type="text/javascript"></script> 
<script src="http://www.google.com/uds/api?file=uds.js&amp;v=1.0" type="text/javascript"></script> 
<script src="http://www.google.com/uds/solutions/localsearch/gmlocalsearch.js" type="text/javascript"></script> 
    
<script type="text/javascript">
function init() {

	/*
		XXX: remove populateDummyData - debugging
	*/
	//probeTags = getDummyData();
	//var probeTags = JSON.parse(localStorage['probes']);

	var probeTags = probeManager.loadProbes();


	console.log('TODO: add communication with background.html\n port.postMessage({probeTagLoad: tagProbe})');
		
	probes = document.getElementById('probes');
	template = xpath('//div[@id="template"]', document);
	spanTag  = xpath('//span[@id="tag"]', template);
	inputTag = xpath('//input[@id="tag_input"]', template);
	inputAvgWeek = xpath('//input[@class="avgWeek"]', template);
	inputAvgDay	 = xpath('//input[@class="avgDay"]', template);

	if(probeTags){
		for (var i in probeTags) {
			addProbeHTML(probeTags[i]);
		}
		addRemoveButtonListeners();
	}
}

function addRemoveButtonListeners(){
	$("span#btnRemove").click(function() {
		
		var probeDiv = $(this).parent('.probe').css('border','1px dotted #ff0000');


		/*
		 * remove from local storage
		 * TODO: change harcoded values
		 */
		var strDivId = probeDiv.attr('id');
		strDivId = strDivId.substring(2);
		probeManager.removeProbeByKey('twitter' + '_' + strDivId);

		/*
		 * remove from HTML
		 */
		probeDiv.remove();
				
		/*
		 * TODO: add communication with background.html
		 */
		 console.log('TODO: add communication with background.html\n port.postMessage({probeTagDeleted: tagProbe})');

	});
	/*
	 * show options
	 */
	$("span#btnOptions").click(function() {
		initializeMap();
		$("div#options").css('display','block');
	});

    $(".probe").click(function () {
    	       $(".probe").removeClass("selected");
    	       $(this).addClass("selected");
    	      }
    ).mouseover( function () {
		 //$(' > #btnRemove',this).removeClass("hd");
		 $(this).addClass("selected");
		    
		}
	).mouseout( function () {
		//$(' > #btnRemove',this).addClass("hd");
	    $(this).removeClass("selected");
	    	 
	    }
	);

    $("input#tag_input").keypress(function (e) {  
        if ((e.which && e.which == 13) || (e.keyCode && e.keyCode == 13)) {  
			save();
        	return false;  
        } else {  
            return true;  
        }  
    });  
	
    
}

function addProbeHTML(tagProbeObj){

	if(tagProbeObj){		

		spanTag.innerHTML = tagProbeObj.query;
		
		spanTag.setAttribute('class','span_tag');			
		inputTag.setAttribute('class','tag hd');
		
		inputTag.setAttribute('value',tagProbeObj.query);
		inputAvgWeek.setAttribute('value',tagProbeObj.shortTermTweetsPerHour);
		inputAvgDay.setAttribute('value',tagProbeObj.longTermTweetsPerHour);
		
		// copy node and update
		item = template.cloneNode(true);	  
		item.setAttribute('id','f_' + tagProbeObj.query.replace(" ","_"));
		
		probes.appendChild(item);
		
	}else{

		spanTag.setAttribute('class','span_tag hd');
		spanTag.innerHTML = '';		
		inputTag.setAttribute('class','tag');
			
		inputTag.setAttribute('value','');
		inputAvgWeek.setAttribute('value','0');
		inputAvgDay.setAttribute('value','0');
		
		// copy node and update
		item = template.cloneNode(true);	  
		item.setAttribute('id','f');

		probes.appendChild(item);

		$("#f.probe > input#tag_input.tag").focus();
		

	}
}

// evaluate xpath
function xpath(path, node) {
  return document.evaluate(path, node).iterateNext();
}

function save() {

	
	$('#f').each(function(i){

		/*
		 * validate search term
		 */
		 var tagObj = $(' > input#tag_input.tag',this);

		 if (!tagObj.val()){
			 $(tagObj).addClass('warn');
			 /*
			  * TODO: add warning message
			  */
			 return false;
		 }

		var tagProbe = new Probe();
		tagProbe.query = tagObj.val();
		tagProbe.shortTermTweetsPerHour = 0;
		tagProbe.longTermTweetsPerHour = 0 ;
		
		$(this).attr('id','f_' + tagProbe.query.replace(" ","_") );
		
		probeManager.setProbe(tagProbe);
		$(this).addClass('loader');
		port.postMessage({probeTagChanged: tagProbe});
		
	});

	//markClean();

	/*
	 * TODO: add communication with background.html
	 */
	 //console.log('TODO: add communication with background.html\n port.postMessage({probeTagAdded: tagProbe})');

	
	//chrome.extension.getBackgroundPage().init();
}

function refresh() {
  startRequest(false);
  document.getElementById('module').src = 'about:blank';
  setIframeUrl();
}	

function goToUrl(url) {
chrome.tabs.getAllInWindow(undefined, function(tabs) {
for (var i = 0, tab; tab = tabs[i]; i++) {
  if (tab.url && (tab.url == url)) {
    chrome.tabs.update(tab.id, {selected: true});
    return;
  }
}
chrome.tabs.create({url: url});
});
}	


function back(){
	$("div#options").css('display','none');
}

var maps_key = "ABQIAAAATfHumDbW3OmRByfquHd3SRTRERdeAiwZ9EeJWta3L_JZVS0bOBRQeZgr4K0xyVKzUdnnuFl8X9PX0w";

function initializeMap() {
  if (GBrowserIsCompatible()) {
  
    // Create and Center a Map
    var map = new GMap2(document.getElementById("map_canvas"));
    map.setCenter(new GLatLng(37.4419, -122.1419), 13);
    map.addControl(new GSmallZoomControl());
    //map.addControl(new GMapTypeControl());

    // bind a search control to the map, suppress result list
    //map.addControl(new google.maps.LocalSearch(), new GControlPosition(G_ANCHOR_BOTTOM_RIGHT, new GSize(10,20)));
  }
}
//GSearch.setOnLoadCallback(initialize);
      
</script>
</div>

<div id="header">
	<img src="img/logo_popup.png" title="Social Media Monitoring" alt="Social Media Monitoring" />
	<div style="position:absolute; top:15px; right: 15px">
    <span class="link" onclick="refresh()">Refresh</span> | <span class="link" onclick="goToUrl('options.html');">Options</span> | <span class="link" onclick="window.close()">Close</span>
	</div>
</div>


<div id="config" style="margin-top: 15px">
<div id="probes">
<div id="template" class="probe"><span id="iconService"></span>
<span id="tag" class="span_tag hd"><!--  --></span>
<input type="text" id="tag_input" class="tag" maxlength="30">

<input type="text" class="avgWeek" disabled="disabled" value="0">
<input type="text" class="avgDay" disabled="disabled" value="0">

<span id="btnRemove"></span> <span id="btnOptions"></span> <span class="clear"><!--  --></span></div>
</div>
<span class="clear"><!--  --></span>
</div>
<span class="clear"><!--  --></span>

<div id="footer">
<span id="btnAdd"> add new</span>

<div class="option_row" style="padding-top:5px;">
	<div class="option_name">Search results in</div>
	<div class="option_picker">
	<select id="open_results">
		<option value="open_in_new_window">a new window</option>
		<option value="open_in_current_window">the current window</option>
	</select>
	<input id="show-button" type="button" value="Show" onclick="openResults();" />
	</div>
</div>
</div>

</body>
</html>